{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "prefix": {
            "type": "String"
        }
    },
    "variables": {
        "linkedTemplates": "https://raw.githubusercontent.com/hoangaws/azureTemplate/main/",
        "eventhubNS": "[concat(parameters('prefix'),'-gw-stream')]",
        "driveEventHub": "[concat(variables('eventhubNS'), '/','drive')]",
        "driveAuthorizationRules": "[concat(parameters('prefix'),'driveAR')]",
        "messagesEventhub": "[concat(variables('eventhubNS'), '/','messages')]",
        "messagesAuthorizationRules": "[concat(parameters('prefix'),'messagesAR')]",
        "iothub": "[concat(parameters('prefix'),'iothub')]",
        "locationCG": "[concat(parameters('prefix'),'locationCG')]",
        "storageAccount": "[concat(parameters('prefix'),'storage')]",
        "driveAppInsight": "[concat(parameters('prefix'),'-dlogs')]",
        "messagesAppInsight": "[concat(parameters('prefix'),'-mlogs')]",
        "documentDB": "[concat(parameters('prefix'),'-db')]",
        "consumptionPlan": "[concat(parameters('prefix'),'cPlan')]",
        "appServicePlan": "[concat(parameters('prefix'),'asPlan')]",
        "locationFunction": "[concat(parameters('prefix'),'-locationproc')]",
        "driveFunction": "[concat(parameters('prefix'),'-driveproc')]",
        "messagesFunction": "[concat(parameters('prefix'),'-messagesproc')]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('eventhubNS')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/newEventhubNS.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('eventhubNS')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('driveEventhub')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/newEventhubs.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[variables('driveEventHub')]"
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('eventhubNS'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('messagesEventhub')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/newEventhubs.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[variables('messagesEventhub')]"
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('eventhubNS'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('driveAuthorizationRules')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/authorizationRules.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('driveAuthorizationRules')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('driveEventhub'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('messagesAuthorizationRules')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/authorizationRules.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('messagesAuthorizationRules')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('messagesEventhub') )]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('iothub')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'IoTHub/newIoTHubs.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('iothub')]" },
                    "eventhubNS": { "value": "[variables('eventhubNS')]" },
                    "eventhubNameIoTdrive": { "value": "[variables('driveEventHub')]" },
                    "eventhubNameIoTmessage": { "value": "[variables('messagesEventhub')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('driveAuthorizationRules'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('messagesAuthorizationRules'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('locationCG')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Eventhub/newConsumergroups.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('locationCG')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('driveEventhub'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('storageAccount')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Storage/newStorageAccount.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('storageAccount')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "sensorData",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Storage/newContainers.json')]"
                },
                "parameters": {
                    "name": { "value": "sensorData" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "TripQueue",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Storage/newQueues.json')]"
                },
                "parameters": {
                    "name": { "value": "TripQueue" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "LastLocationByDevice",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Storage/newTables.json')]"
                },
                "parameters": {
                    "name": { "value": "LastLocationByDevice" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]"
            ]
        },

        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('driveAppInsight')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newAppIns.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('driveAppInsight')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('messagesAppInsight')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newAppIns.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('messagesAppInsight')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('documentDB')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'Storage/newDocumentDB.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('documentDB')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('consumptionPlan')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newConsumptionPlan.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('consumptionPlan')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('appServicePlan')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newAppServicePlan.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('appServicePlan')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('locationFunction')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newFunctionApps.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('locationFunction')]" },
                    "serverfarms": { "value": "[variables('consumptionPlan')]" },
                    "appInsight": { "value": "[variables('driveAppInsight')]" },
                    "storage": { "value": "[variables('storageAccount')]" },
                    "documentDB": { "value": "[variables('documentDB')]" },
                    "eventhubNS": { "value": "[variables('eventhubNS')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('locationCG'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('consumptionPlan'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('driveAppInsight'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('documentDB'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('eventhubNS'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('driveFunction')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newFunctionApps.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('driveFunction')]" },
                    "serverfarms": { "value": "[variables('consumptionPlan')]" },
                    "appInsight": { "value": "[variables('driveAppInsight')]" },
                    "storage": { "value": "[variables('storageAccount')]" },
                    "documentDB": { "value": "[variables('documentDB')]" },
                    "eventhubNS": { "value": "[variables('eventhubNS')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('driveEventhub'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('consumptionPlan'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('driveAppInsight'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('documentDB'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('eventhubNS'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('messagesFunction')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('linkedTemplates'), 'AppService/newFunctionApps.json')]"
                },
                "parameters": {
                    "name": { "value": "[variables('messagesFunction')]" },
                    "serverfarms": { "value": "[variables('appServicePlan')]" },
                    "appInsight": { "value": "[variables('driveAppInsight')]" },
                    "storage": { "value": "[variables('storageAccount')]" },
                    "documentDB": { "value": "[variables('documentDB')]" },
                    "eventhubNS": { "value": "[variables('eventhubNS')]" }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('messagesEventhub'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('appServicePlan'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('messagesAppInsight'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('storageAccount'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('documentDB'))]",
                "[resourceId('Microsoft.Resources/deployments', variables('eventhubNS'))]"
            ]
        }
    ]
}
